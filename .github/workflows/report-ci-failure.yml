name: Report CI Failure

on:
  workflow_run:
    workflows: ["Verify Codebase"]
    types:
      - completed

jobs:
  report-failure:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'
    permissions:
      issues: write
      contents: read
      actions: write
      pull-requests: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.repository.default_branch }}
          persist-credentials: false

      - name: Select trusted PRs
        id: trusted_prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          EXTRA_TRUSTED_ACTORS: ${{ vars.JULES_TRUSTED_ACTORS }}
        run: |
          set -euo pipefail
          echo '${{ toJSON(github.event.workflow_run) }}' > workflow_run.json

          PR_NUMBERS=$(jq -r '.pull_requests[]?.number' workflow_run.json)
          if [ -z "$PR_NUMBERS" ]; then
            HEAD_BRANCH=$(jq -r '.head_branch // empty' workflow_run.json)
            if [ -n "$HEAD_BRANCH" ]; then
              echo "No PRs found in payload. Looking up PRs for branch: $HEAD_BRANCH"
              PR_NUMBERS=$(gh pr list \
                --repo "${{ github.repository }}" \
                --head "$HEAD_BRANCH" \
                --state all \
                --json number \
                -q '.[].number')
            fi
          fi

          TRUSTED_PR_NUMBERS=""
          for PR_NUMBER in $PR_NUMBERS; do
            echo "Evaluating trust for PR #$PR_NUMBER"
            if ! PR_JSON=$(gh pr view "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --json number,author,isCrossRepository,headRepositoryOwner); then
              echo "Failed to load PR #$PR_NUMBER metadata. Skipping."
              continue
            fi

            if printf '%s' "$PR_JSON" | python3 automation_trust.py pr \
              --repo-owner "$REPO_OWNER" \
              --extra-trusted-actors "$EXTRA_TRUSTED_ACTORS" \
              --pr-file -; then
              TRUSTED_PR_NUMBERS="${TRUSTED_PR_NUMBERS}${TRUSTED_PR_NUMBERS:+ }$PR_NUMBER"
            else
              echo "Skipping untrusted or cross-repository PR #$PR_NUMBER"
            fi
          done

          echo "trusted_pr_numbers=$TRUSTED_PR_NUMBERS" >> "$GITHUB_OUTPUT"

      - name: Report Failure
        if: ${{ steps.trusted_prs.outputs.trusted_pr_numbers != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          set -euo pipefail
          # Save payload to file
          echo '${{ toJSON(github.event.workflow_run) }}' > workflow_run.json

          PR_NUMBERS='${{ steps.trusted_prs.outputs.trusted_pr_numbers }}'

          if [ -z "$PR_NUMBERS" ]; then
            echo "No trusted PRs associated with this run."
            exit 0
          fi

          # Download logs
          # We use || true to prevent failure if logs are missing or retrieval fails
          gh run view "$RUN_ID" --log-failed > failed.log 2>&1 || echo "Failed to retrieve logs" > failed.log

          # Extract snippet
          python3 .github/scripts/extract_log.py failed.log > snippet.txt

          for PR_NUMBER in $PR_NUMBERS; do
            echo "Creating issue for PR #$PR_NUMBER"
            TITLE="CI Failure: PR #$PR_NUMBER"

            # Construct body using echo to avoid YAML indentation issues with heredoc
            echo "The CI check failed for PR #$PR_NUMBER." > issue_body.md
            echo "" >> issue_body.md
            echo "**Log Snippet:**" >> issue_body.md
            echo "\`\`\`" >> issue_body.md
            cat snippet.txt >> issue_body.md
            echo "\`\`\`" >> issue_body.md
            echo "" >> issue_body.md
            echo "[View Full Logs](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)" >> issue_body.md

            # Create issue using REST API to avoid GraphQL permission edge cases
            ISSUE_NUMBER=$(jq -Rs --arg title "$TITLE" '{title: $title, body: .}' issue_body.md \
              | gh api \
                  --method POST \
                  "repos/${{ github.repository }}/issues" \
                  --input - \
                  -q '.number' 2>/tmp/issue_create_error.log || true)

            if [ -n "$ISSUE_NUMBER" ]; then
              echo "Created issue #$ISSUE_NUMBER. Triggering Jules..."
              gh workflow run run-agent.yml -f issue_number="$ISSUE_NUMBER" || echo "Warning: Failed to trigger Jules workflow"
            else
              # Issue creation might have failed but issue could exist - search for it
              sleep 2
              CREATED_ISSUE=$(gh api "repos/${{ github.repository }}/issues?state=open&per_page=100" \
                | jq -r --arg title "$TITLE" '.[] | select((has("pull_request") | not) and .title == $title) | .number' \
                | head -n 1)
              if [ -n "$CREATED_ISSUE" ]; then
                echo "Found issue #$CREATED_ISSUE (created despite error). Triggering Jules..."
                gh workflow run run-agent.yml -f issue_number="$CREATED_ISSUE" || echo "Warning: Failed to trigger Jules workflow"
              else
                echo "::error::Failed to create or find issue for PR #$PR_NUMBER"
                echo "Error output: $(cat /tmp/issue_create_error.log 2>/dev/null || true)"
              fi
            fi
          done

      - name: Skip untrusted PRs
        if: ${{ steps.trusted_prs.outputs.trusted_pr_numbers == '' }}
        run: echo "No trusted same-repository PRs found for this failed workflow run."
