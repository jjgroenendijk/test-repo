name: Manage PR Lifecycle

on:
  workflow_run:
    workflows: ["Verify Codebase"]
    types:
      - completed

jobs:
  auto-merge:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.repository.default_branch }}
          persist-credentials: false

      - name: Merge Passed PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          TRUSTED_ACTORS: ${{ vars.JULES_TRUSTED_ACTORS }}
        run: |
          set -euo pipefail
          echo '${{ toJSON(github.event.workflow_run) }}' > workflow_run.json

          PR_NUMBERS=$(jq -r '.pull_requests[]?.number' workflow_run.json)
          if [ -z "$PR_NUMBERS" ]; then
            HEAD_BRANCH=$(jq -r '.head_branch // empty' workflow_run.json)
            if [ -n "$HEAD_BRANCH" ]; then
              echo "No PRs in payload. Looking up open PRs for branch: $HEAD_BRANCH"
              PR_NUMBERS=$(gh pr list \
                --repo "${{ github.repository }}" \
                --head "$HEAD_BRANCH" \
                --state open \
                --json number \
                -q '.[].number')
            fi
          fi

          if [ -z "$PR_NUMBERS" ]; then
            echo "No open PRs found for Verify Codebase run $RUN_ID."
            exit 0
          fi

          for PR_NUMBER in $PR_NUMBERS; do
            echo "Processing PR #$PR_NUMBER"

            PR_DATA=$(gh pr view "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --json state,author,isCrossRepository,headRepositoryOwner)
            PR_STATE=$(echo "$PR_DATA" | jq -r '.state')
            if [ "$PR_STATE" != "OPEN" ]; then
              echo "PR #$PR_NUMBER is $PR_STATE. Skipping."
              continue
            fi

            PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login // empty')
            PR_IS_CROSS=$(echo "$PR_DATA" | jq -r '.isCrossRepository')
            PR_HEAD_OWNER=$(echo "$PR_DATA" | jq -r '.headRepositoryOwner.login // empty')
            if ! python3 automation_trust.py pr \
              --author "$PR_AUTHOR" \
              --head-owner "$PR_HEAD_OWNER" \
              --is-cross "$PR_IS_CROSS" \
              --repo-owner "${{ github.repository_owner }}" \
              --trusted-actors "$TRUSTED_ACTORS"; then
              echo "PR #$PR_NUMBER is not a trusted same-repo PR. Skipping auto-merge."
              continue
            fi

            gh pr review "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --approve || echo "Approval step skipped or failed."

            if gh pr merge "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --merge \
              --delete-branch; then
              echo "Merged PR #$PR_NUMBER"
              continue
            fi

            echo "Merge failed for PR #$PR_NUMBER. Checking for conflicts."
            python3 .github/scripts/detect_merge_conflicts.py --pr-number "$PR_NUMBER"
          done
