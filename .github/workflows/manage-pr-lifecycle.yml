name: Manage PR Lifecycle

on:
  workflow_run:
    workflows: ["Verify Codebase"]
    types:
      - completed

jobs:
  auto-merge:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.repository.default_branch }}
          persist-credentials: false

      - name: Select trusted PRs
        id: trusted_prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          EXTRA_TRUSTED_ACTORS: ${{ vars.JULES_TRUSTED_ACTORS }}
        run: |
          set -euo pipefail
          echo '${{ toJSON(github.event.workflow_run) }}' > workflow_run.json

          PR_NUMBERS=$(jq -r '.pull_requests[]?.number' workflow_run.json)
          if [ -z "$PR_NUMBERS" ]; then
            HEAD_BRANCH=$(jq -r '.head_branch // empty' workflow_run.json)
            if [ -n "$HEAD_BRANCH" ]; then
              echo "No PRs in payload. Looking up open PRs for branch: $HEAD_BRANCH"
              PR_NUMBERS=$(gh pr list \
                --repo "${{ github.repository }}" \
                --head "$HEAD_BRANCH" \
                --state open \
                --json number \
                -q '.[].number')
            fi
          fi

          TRUSTED_PR_NUMBERS=""
          for PR_NUMBER in $PR_NUMBERS; do
            echo "Evaluating trust for PR #$PR_NUMBER"
            if ! PR_JSON=$(gh pr view "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --json number,author,isCrossRepository,headRepositoryOwner); then
              echo "Failed to load PR #$PR_NUMBER metadata. Skipping."
              continue
            fi

            if printf '%s' "$PR_JSON" | python3 automation_trust.py pr \
              --repo-owner "$REPO_OWNER" \
              --extra-trusted-actors "$EXTRA_TRUSTED_ACTORS" \
              --pr-file -; then
              TRUSTED_PR_NUMBERS="${TRUSTED_PR_NUMBERS}${TRUSTED_PR_NUMBERS:+ }$PR_NUMBER"
            else
              echo "Skipping untrusted or cross-repository PR #$PR_NUMBER"
            fi
          done

          echo "trusted_pr_numbers=$TRUSTED_PR_NUMBERS" >> "$GITHUB_OUTPUT"

      - name: Merge Passed PRs
        if: ${{ steps.trusted_prs.outputs.trusted_pr_numbers != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          set -euo pipefail
          PR_NUMBERS='${{ steps.trusted_prs.outputs.trusted_pr_numbers }}'

          if [ -z "$PR_NUMBERS" ]; then
            echo "No trusted open PRs found for Verify Codebase run $RUN_ID."
            exit 0
          fi

          for PR_NUMBER in $PR_NUMBERS; do
            echo "Processing PR #$PR_NUMBER"

            PR_STATE=$(gh pr view "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --json state \
              -q '.state')
            if [ "$PR_STATE" != "OPEN" ]; then
              echo "PR #$PR_NUMBER is $PR_STATE. Skipping."
              continue
            fi

            gh pr review "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --approve || echo "Approval step skipped or failed."

            if gh pr merge "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --merge \
              --delete-branch; then
              echo "Merged PR #$PR_NUMBER"
              continue
            fi

            echo "Merge failed for PR #$PR_NUMBER. Checking for conflicts."
            python3 .github/scripts/detect_merge_conflicts.py --pr-number "$PR_NUMBER"
          done

      - name: Skip untrusted PRs
        if: ${{ steps.trusted_prs.outputs.trusted_pr_numbers == '' }}
        run: echo "No trusted same-repository PRs found for this workflow run."
